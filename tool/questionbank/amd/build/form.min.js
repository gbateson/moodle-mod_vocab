/**
 * mod/vocab/tool/questionbank/amd/src/form.js
 *
 * @module vocabtool_questionbank
 * @copyright 2023 Gordon Bateson (gordon.bateson@gmail.com)
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since Moodle 3.11
 */
define("vocabtool_questionbank/form",["core/str"],(function(STR){let JS={};return window.JS=JS,JS.str={},JS.add_event_listener=function(obj,evt,fn,useCapture){obj.addEventListener?obj.addEventListener(evt,fn,useCapture||!1):obj.attachEvent&&obj.attachEvent("on"+evt,fn)},JS.init=function(defaults){this.init_selectall_logs(),this.init_textareas_logs(),this.init_selectall_words(),this.init_checkboxes_words(),defaults&&JS.init_prompt(defaults),STR.get_strings([{key:"addname",component:"vocabtool_questionbank"},{key:"addtags",component:"vocabtool_questionbank"}]).done((function(s){let i=0;JS.str.addname=s[i++],JS.str.addtags=s[i++],JS.init_custom_names()}))},JS.init_selectall_logs=function(){const selectall=document.querySelector('input[type="checkbox"][name="logids[selectall]"]');selectall&&(JS.add_event_listener(selectall,"click",JS.onclick_selectall),selectall.classList.contains("d-none")&&selectall.classList.remove("d-none"))},JS.init_textareas_logs=function(){document.querySelectorAll("#id_log_error, #id_log_prompt, #id_log_results").forEach((function(textarea){JS.add_event_listener(textarea,"input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+6+"px"})),textarea.dispatchEvent(new Event("input"))}))},JS.init_selectall_words=function(){const selectall=document.querySelector('input[type="checkbox"][name="selectedwords[selectall]"]');if(selectall){JS.add_event_listener(selectall,"click",JS.onclick_selectall);const label=selectall.closest("label");if(label){label.classList.contains("d-none")&&label.classList.remove("d-none"),label.classList.add("btn","btn-light","border-dark"),label.classList.add("align-self-start","px-2","py-0");const p=label.closest(".fcontainer").querySelector(".col-form-label p");p&&p.replaceWith(label)}}},JS.onclick_selectall=function(){const checked=this.checked,s='input[type="checkbox"][name^="'+this.name.substr(0,this.name.indexOf("["))+'"]';this.closest("fieldset").querySelectorAll(s).forEach((function(cb){cb.checked=checked}));let txt="";if(txt=checked?this.dataset.deselectall||"":this.dataset.selectall||"",txt){const label=this.closest("label");if(label){for(let i=label.childNodes.length-1;i>=0;i--){const n=label.childNodes[i];3==n.nodeType&&label.removeChild(n)}label.appendChild(document.createTextNode(txt))}}return!0},JS.init_checkboxes_words=function(){document.querySelectorAll('input[type="checkbox"][name^="selectedwords"]').forEach((function(cb){JS.add_event_listener(cb,"click",JS.onclick_checkbox)}))},JS.onclick_checkbox=function(evt){const felement=this.closest(".felement");if(null===felement)return!0;const dataclicked='input[type="checkbox"][data-clicked="1"]',cb_start=felement.querySelector(dataclicked),cb_stop=evt.currentTarget;let unclickall=!1,clickme=!0;if(evt.shiftKey)if(cb_start){let found=!1,startstop=!1;felement.querySelectorAll('input[type="checkbox"]').forEach((function(cb){startstop=cb==cb_start||cb==cb_stop,(found||startstop)&&(cb.checked=evt.currentTarget.checked,startstop&&(found=!found))})),unclickall=!0}else clickme=!0;else unclickall=!0,clickme=!0;unclickall&&felement.querySelectorAll(dataclicked).forEach((function(cb){cb.removeAttribute("data-clicked")})),clickme&&evt.currentTarget.setAttribute("data-clicked","1")},JS.init_custom_names=function(){JS.init_custom_name("[name='subcat[name]']",".subcatnames","addname"),JS.init_custom_name("[name='qtag[name]']",".tagnames","addtags")},JS.init_custom_name=function(sourceselector,targetselector,strname){let fitem=document.querySelector(sourceselector).closest(".fitem"),table=document.querySelector("#questionbanklog_table"),allnames=[];table.querySelectorAll(targetselector).forEach((function(ul){let names=[];if(ul.querySelectorAll("li").forEach((function(li){names.push(li.innerText)})),names.length&&(names=names.join(", "),allnames.indexOf(names)<0)){allnames.push(names);let separator=Object.assign(document.createElement("span"),{className:"w-100"}),div=Object.assign(document.createElement("div"),{className:"rounded border border-warning bg-light ml-4 my-1 pr-2 customnames"});div.appendChild(Object.assign(document.createElement("button"),{className:"btn btn-warning ml-0 py-1 px-2",onclick:JS.onclick_add_tags,textContent:JS.str[strname]})),div.appendChild(Object.assign(document.createElement("span"),{className:"ml-2",textContent:names})),fitem.parentNode.insertBefore(separator,fitem.nextSibling),separator.parentNode.insertBefore(div,separator.nextSibling)}}))},JS.onclick_add_tags=function(evt){evt.preventDefault();let btn=evt.currentTarget,div=btn.closest(".customnames"),span=btn.nextElementSibling;if(div&&span){let inputfitem=JS.get_previous_sibling(div,".fitem");if(inputfitem){let input=inputfitem.querySelector("input[type='text']");if(input){input.value=span.textContent.trim(),input.disabled&&(input.disabled=!1);let checkboxfitem=JS.get_previous_sibling(inputfitem,".fitem");if(checkboxfitem){let checkbox=checkboxfitem.querySelector("input[type='checkbox']");checkbox&&(checkbox.checked=!0)}}}}return btn.blur(),!1},JS.get_previous_sibling=function(elm,selector){selector||(selector="");let sibling=elm.previousElementSibling;for(;sibling;){if(""==selector||sibling.matches(selector))return sibling;sibling=sibling.previousElementSibling}return null},JS.init_prompt=function(defaults){const p=document.querySelector("select[name='prompt']");if(p){let selectnames=[];const s="select:not([name='prompt'])";p.closest(".fcontainer").querySelectorAll(s).forEach((function(select){selectnames.push(select.name)})),p.dataset.selectnames=selectnames.join(","),JS.add_event_listener(p,"change",(function(evt){const elm=evt.target;let selectnames=elm.dataset.selectnames.split(",");const promptid=elm.options[elm.selectedIndex].value;if(promptid&&defaults[promptid]){let settings=defaults[promptid];for(let n in settings)if("qtypes"==n)JS.set_qtypes(settings[n]);else if("subcattypes"==n)JS.set_checkboxes("subcat",settings[n]);else if("subcatname"==n)JS.set_customname("subcat",settings[n]);else if("tagtypes"==n)JS.set_checkboxes("qtag",settings[n]);else if("tagnames"==n)JS.set_customname("qtag",settings[n]);else{const elm=document.querySelector("[name='"+n+"']");if(elm)if("SELECT"==elm.tagName){const i=selectnames.indexOf(n);i>=0&&selectnames.splice(i,1);const s="option[value='"+settings[n]+"']",option=elm.querySelector(s);option&&0==option.selected&&(option.selected=!0)}else"INPUT"==elm.tagName&&"text"==elm.type&&(elm.value=settings[n])}selectnames.forEach((function(name){const s="select[name='"+name+"']",select=document.querySelector(s);select&&(select.options[0].selected=!0)}))}})),p.dispatchEvent(new Event("change"))}},JS.set_qtypes=function(qtypes){document.querySelectorAll("#id_questiontypescontainer .felement").forEach((function(felement){const enable=felement.querySelector("input[type='checkbox'][name$='[enable]']"),format=felement.querySelector("select[name$='[format]']");if(enable&&format){const i=enable.name.indexOf("["),t=enable.name.substr(0,i);if(qtypes[t]){0==enable.checked&&(enable.checked=!0,enable.dispatchEvent(new Event("click")));const formatid=qtypes[t],option=format.querySelector("option[value='"+formatid+"']");option&&0==option.selected&&(option.selected=!0)}else 1==enable.checked&&(enable.checked=!1,enable.dispatchEvent(new Event("click")),format.options[0].selected=!0)}}))},JS.set_checkboxes=function(name,value){const r=new RegExp("^"+name+"\\[(\\d+)\\]$"),s="input[type='checkbox'][name^='"+name+"['][name$=']']";document.querySelectorAll(s).forEach((function(cb){const m=cb.name.match(r);if(m&&m[0]){const i=value&parseInt(m[1]);cb.checked=!!i}}))},JS.set_customname=function(name,value){const s={checkbox:"input[type='checkbox'][name^='"+name+"']",input:"input[type='text'][name='"+name+"[name]']",fitem:".fitem"},input=document.querySelector(s.input);if(null===input)return!1;const fitem=JS.get_previous_sibling(input.closest(s.fitem),s.fitem);if(null===fitem)return!1;const cb=fitem.querySelector(s.checkbox);if(null===cb)return!1;0==cb.checked&&(cb.checked=!0,cb.dispatchEvent(new Event("click"))),input.value=value},JS}));

//# sourceMappingURL=form.min.js.map